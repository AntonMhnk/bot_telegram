require("dotenv").config();
const express = require("express");
const cors = require("cors");
const bodyParser = require("body-parser");
const TelegramBot = require("node-telegram-bot-api");

const app = express();

// Configure CORS with more detailed options
app.use(
	cors({
		origin: "*", // Allow all origins
		methods: ["GET", "POST", "OPTIONS"],
		allowedHeaders: ["Content-Type"],
	})
);
app.use(bodyParser.json());

const token = process.env.TG_BOT_API_KEY;
const urlCom = "https://t.me/+ur3meeF_bOo1ZGRi";
const photoPath = "./images/spaceImage.webp";
const botUsername = "NebulaHuntBot"; // Add your bot username
const myAppName = "myapp";

// Initialize Telegram bot with optimized settings
const bot = new TelegramBot(token, { polling: true });

bot.on("message", async (msg) => {
	const chatId = msg.chat.id;
	const text = msg.text;

	const caption = `Welcome to Nebula Hunt! ðŸš€\n\nYou are about to embark on a journey through the unexplored corners of the universe.\n\nScan deep space, discover ancient planets, and build your own galactic legacy.\n\nðŸŒŒ Tap "Open game!" to begin your mission.\n\nðŸª Rare worlds await. Someâ€¦ may even change everything.\n\nGood luck, Pioneer. The stars are watching.`;

	if (text && text.startsWith("/start")) {
		try {
			// Check if this is a referral link
			const args = text.split(" ");
			let startParam = "ABC";
			let isReferral = false;
			let referrerId = null;

			if (args.length > 1) {
				startParam = args[1];
				// Check if it's a referral code
				if (startParam.startsWith("ref_")) {
					isReferral = true;
					referrerId = startParam.substring(4);
					console.log(
						`Referral detected! User ${chatId} was referred by ${referrerId}`
					);

					// Here you would store this referral in your database
					// For this example, we'll just log it
				}
			}

			const webAppUrl = `https://t.me/${botUsername}/${myAppName}?startapp=${startParam}`;

			// Send welcome message
			await bot.sendPhoto(chatId, photoPath, {
				caption: caption,
				reply_markup: {
					inline_keyboard: [
						[
							{
								text: "ðŸª Open game!",
								url: webAppUrl,
							},
						],
						[{ text: "Join community!", url: urlCom }],
					],
				},
			});

			// If this was a referral, send additional messages
			if (isReferral) {
				await bot.sendMessage(
					chatId,
					"ðŸŽ You were invited by a friend! Open the game to receive your welcome bonus of 5,000 Stardust and 10 Dark Matter!"
				);

				// Notify the referrer if possible
				try {
					await bot.sendMessage(
						referrerId,
						`ðŸŽ‰ Great news! Someone joined using your referral link. You'll receive your reward of 5,000 Stardust and 10 Dark Matter when they open the game!`
					);
				} catch (referrerError) {
					console.log(
						`Could not notify referrer ${referrerId}: ${referrerError.message}`
					);
				}
			}
		} catch (error) {
			console.error("Error sending start message:", error);
			await bot.sendMessage(
				chatId,
				"Welcome to Nebula Hunt! Please try opening the game again."
			);
		}
	}
});

// Store items
const storeItems = [
	{
		id: 1,
		name: "Space Explorer Pack",
		description: "Unlock special space exploration features",
		stars: 100,
		image: "ðŸš€",
	},
	{
		id: 2,
		name: "Cosmic Boost",
		description: "Temporary speed boost for your spaceship",
		stars: 50,
		image: "âš¡",
	},
	{
		id: 3,
		name: "Galactic Weapon",
		description: "Powerful weapon for space battles",
		stars: 200,
		image: "ï¿½ï¿½",
	},
	{
		id: 4,
		name: "VIP Explorer",
		description: "VIP status with exclusive benefits",
		stars: 150,
		image: "ðŸ‘‘",
	},
];

// Get store items with invoice links
app.get("/api/store-items", async (req, res) => {
	try {
		const itemsWithInvoiceLinks = await Promise.all(
			storeItems.map(async (item) => {
				try {
					const invoiceLink = await bot.createInvoiceLink(
						item.name, // title
						item.description, // description
						"{}", // payload - must be empty for Stars
						"", // provider_token - must be empty for Stars
						"XTR", // currency - must be XTR for Stars
						[{ amount: item.stars, label: `${item.stars} Stars` }] // prices
					);
					return {
						...item,
						invoiceLink,
					};
				} catch (error) {
					console.error(
						`Error creating invoice link for item ${item.id}:`,
						error
					);
					return {
						...item,
						error: "Failed to create invoice link",
					};
				}
			})
		);

		res.json({ success: true, items: itemsWithInvoiceLinks });
	} catch (error) {
		console.error("Error getting store items:", error);
		res.status(500).json({
			success: false,
			error: error.message,
		});
	}
});

// API endpoint to create payment
app.post("/api/create-payment", async (req, res) => {
	try {
		const { amount, description, title, paymentType, galaxySeed } = req.body;

		// Validate amount
		if (!amount || amount < 1 || amount > 100000) {
			return res.status(400).json({
				success: false,
				error: "Invalid amount. Must be between 1 and 100,000 stars.",
			});
		}

		console.log("Creating invoice with data:", {
			amount,
			title,
			description,
			paymentType,
		});

		// Determine appropriate title and description for the invoice
		let invoiceTitle = title || "Buy Stars";
		let invoiceDescription =
			description || `Purchase ${amount} stars to expand your galaxy`;

		// Set more detailed descriptions based on payment type
		if (paymentType === "buyStardust") {
			invoiceTitle = "Buy Stardust";
			invoiceDescription = `Purchase ${amount} Telegram Stars to get Stardust in Nebula Hunt. Stardust is used to create new stars in your galaxies.`;
		} else if (paymentType === "captureGalaxy") {
			invoiceTitle = "Capture Galaxy";
			invoiceDescription = `Purchase ${amount} Telegram Stars to capture a galaxy with ${galaxySeed} stars. Once captured, the galaxy will be permanently owned by you.`;
		} else if (paymentType === "darkMatter") {
			invoiceTitle = "Buy Dark Matter";
			invoiceDescription = `Purchase ${amount} Telegram Stars to get Dark Matter in Nebula Hunt. Dark Matter is a premium resource used for rare upgrades.`;
		} else if (paymentType === "galaxyUpgrade") {
			invoiceTitle = "Galaxy Upgrade";
			invoiceDescription = `Purchase ${amount} Telegram Stars to upgrade your galaxy. This will permanently enhance your galaxy with custom features.`;
		}

		// Create invoice link for Telegram Stars payment
		const invoiceLink = await bot.createInvoiceLink(
			invoiceTitle,
			invoiceDescription, // Improved description
			"{}", // payload - must be empty for Stars
			"", // provider_token - must be empty for Stars
			"XTR", // currency - must be XTR for Stars
			[
				{
					amount: amount,
					label: `${amount} ${amount === 1 ? "Star" : "Stars"}`,
				},
			] // prices
		);

		console.log("Invoice link created successfully:", invoiceLink);
		res.json({ success: true, invoiceLink });
	} catch (error) {
		console.error("Error creating payment:", {
			message: error.message,
			stack: error.stack,
			response: error.response?.data,
		});
		res.status(500).json({
			success: false,
			error: "Failed to create payment. Please try again.",
			details: error.response?.data || "No additional details available",
		});
	}
});

// Create a new API endpoint to verify and process referrals
app.post("/api/process-referral", async (req, res) => {
	try {
		const { userId, referrerId } = req.body;

		// In a real implementation, you would:
		// 1. Verify this is a valid referral (check if not already processed)
		// 2. Store the referral in your database
		// 3. Track rewards given to both users

		console.log(
			`Processing referral: User ${userId} was referred by ${referrerId}`
		);

		// For now, just return success
		res.json({
			success: true,
			message: "Referral processed successfully",
			rewards: {
				stardust: 5000,
				darkMatter: 10,
			},
		});
	} catch (error) {
		console.error("Error processing referral:", error);
		res.status(500).json({
			success: false,
			error: "Failed to process referral",
		});
	}
});

// API endpoint Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð¾ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾Ð¼ ÑÐ±Ð¾Ñ€Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
app.post("/api/send-collection-notification", async (req, res) => {
	try {
		const { userId, stardustAmount, darkMatterAmount, language } = req.body;

		// ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ ID Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¿Ñ€ÐµÐ´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½
		if (!userId) {
			return res.status(400).json({
				success: false,
				error: "User ID is required",
			});
		}

		// ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ ÑÐ·Ñ‹Ðº ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð°Ð½Ð³Ð»Ð¸Ð¹ÑÐºÐ¸Ð¹)
		const userLanguage = language || "en";

		// Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÑÐ·Ñ‹ÐºÐ° Ð¸ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð²
		let messageText = "";

		if (userLanguage === "ru") {
			// Ð ÑƒÑÑÐºÐ°Ñ Ð²ÐµÑ€ÑÐ¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
			messageText = "ðŸŒŸ Ð’Ð°ÑˆÐµ Ñ…Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ€ÐµÑÑƒÑ€ÑÐ¾Ð² Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº ÑÐ±Ð¾Ñ€Ñƒ!";

			// Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ°Ñ…
			if (stardustAmount && stardustAmount > 0) {
				messageText += `\n\nâœ¨ Ð—Ð²ÐµÐ·Ð´Ð½Ð°Ñ Ð¿Ñ‹Ð»ÑŒ: ${stardustAmount}`;
			}

			if (darkMatterAmount && darkMatterAmount > 0) {
				messageText += `\n\nðŸŒ‘ Ð¢ÐµÐ¼Ð½Ð°Ñ Ð¼Ð°Ñ‚ÐµÑ€Ð¸Ñ: ${darkMatterAmount}`;
			}

			messageText += "\n\nÐ—Ð°Ð¹Ð´Ð¸Ñ‚Ðµ Ð² Ð¸Ð³Ñ€Ñƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑÐ¾Ð±Ñ€Ð°Ñ‚ÑŒ Ñ€ÐµÑÑƒÑ€ÑÑ‹!";
		} else {
			// ÐÐ½Ð³Ð»Ð¸Ð¹ÑÐºÐ°Ñ Ð²ÐµÑ€ÑÐ¸Ñ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
			messageText = "ðŸŒŸ Your resource storage is full and ready to collect!";

			// Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ€ÐµÑÑƒÑ€ÑÐ°Ñ…
			if (stardustAmount && stardustAmount > 0) {
				messageText += `\n\nâœ¨ Stardust: ${stardustAmount}`;
			}

			if (darkMatterAmount && darkMatterAmount > 0) {
				messageText += `\n\nðŸŒ‘ Dark Matter: ${darkMatterAmount}`;
			}

			messageText += "\n\nOpen the game to collect your resources!";
		}

		// Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð° Ð² Ð¸Ð³Ñ€Ñƒ Ñ Ñ‚ÐµÐºÑÑ‚Ð¾Ð¼ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ ÑÐ·Ñ‹ÐºÐ°
		const webAppUrl = `https://t.me/${botUsername}/${myAppName}`;
		const buttonText =
			userLanguage === "ru" ? "ðŸª ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¸Ð³Ñ€Ñƒ" : "ðŸª Open Game";

		// ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ñ‡ÐµÑ€ÐµÐ· Ð±Ð¾Ñ‚
		await bot.sendMessage(userId, messageText, {
			reply_markup: {
				inline_keyboard: [
					[
						{
							text: buttonText,
							url: webAppUrl,
						},
					],
				],
			},
		});

		console.log(
			`Sent collection notification to user ${userId} in ${userLanguage}`
		);

		// Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð¾Ñ‚Ð²ÐµÑ‚
		res.json({
			success: true,
			message: "Notification sent successfully",
		});
	} catch (error) {
		console.error("Error sending collection notification:", error);
		res.status(500).json({
			success: false,
			error: "Failed to send notification",
			details: error.message,
		});
	}
});

// Handle OPTIONS requests for CORS
app.options("*", cors());

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
	console.log(`Server running on port ${PORT}`);
});

// Export the Express API
module.exports = app;
